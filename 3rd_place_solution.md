運営およびホストの皆さま、学びが多く楽しいコンペの開催ありがとうございました。
参加者の皆さま、お疲れ様でした。また、素晴らしいdiscussionの投稿ありがとうございました。
Private 3位の解法を紹介します。

# 概要
- 候補生成→Rankerによる並び替えのTwo-Stage推薦
- トレンドを意識した候補や特徴量の作り込みが重要だった
- Public Score = 0.4496, Private Score = 0.4458

# 候補生成
- 複数の候補生成ロジックから、1セッションあたり中央値で40個程度の候補を作成
- 全期間で計算した候補に加え、各期間（train or test）のみで計算した候補を加えることで精度が改善した
    - 例えばpopularity baseの候補生成であれば「trainとtestを合算したログで計算した人気宿」と「trainログのみの人気宿、testログのみの人気宿」をそれぞれ計算して候補にするイメージ
- 候補生成のロジック
    - すでにセッションに出現した宿
    - 人気宿
        - 同一sml_cd内
        - 同一lrg_cd内
    - 類似宿
        - sml_cdおよび宿の属性が一致する宿
    - [アソシエーションルール](https://www.guruguru.science/competitions/22/discussions/8bd0183b-867e-4bbf-a4a7-1dbf8aaa582b/)
        - 1-hop (a->b)
        - 2-hop (a->b->c)
    - 行列分解
        - [implicit matrix factrization](https://benfred.github.io/implicit/api/models/cpu/als.html)
        - [bayesian personalized ranking](https://benfred.github.io/implicit/api/models/cpu/bpr.html)
    - item2vec
    - グラフ
        - [ProNE](https://www.ijcai.org/proceedings/2019/0594.pdf)

# 特徴量エンジニアリング
- train/testでのトレンドを考慮した特徴量が重要だった
    - 例えば「train/testの全期間で計算した宿の出現回数に対する、train or testでの出現回数の割合」など
- ロバストな特徴量になるように工夫
    - 「各期間（train or test）での宿の閲覧回数」を特徴量としてしまうと、trainとtestでは（おそらく）期間が違うため、数字の持つ意味が変わってしまう（極端な例だと1年で100回閲覧される、と、1日で100回閲覧される、とでは"100"の持つ意味が変わる）
    - 出現回数ではなく「その地域全体の閲覧回数に対する割合」など、期間が変わっても意味が変わらない特徴量を作るようにした
    - 最序盤はCV/LBが相関しない問題があったが、この対応によりそれが解決
- 合計100程度の特徴量を作成。以下にいくつか例をあげる
    - アイテム特徴
        - 基本属性（温泉フラグ、部屋数など）
        - 全期間に対する各期間の閲覧回数の割合
        - その地域全体の閲覧回数に対する、その宿の閲覧回数の割合
    - セッション特徴
        - セッションの長さ
        - セッション内の宿の基本属性
        - 閲覧した宿の部屋数の統計量（平均、最大、など）
    - アイテム * セッション特徴
        - セッション内で何回出現したか
        - セッションの後ろから何番目に出現しているか
    - 協調フィルタリング関連の特徴
        - セッション内の宿と候補宿の共起回数
    - 類似度特徴
        - 宿の属性に基づく類似度
        - 行列分解で得られたセッションと宿の埋め込みに基づくスコア
        - item2vec, ProNEで得られた宿の埋め込みに基づく類似度
        
# モデリング
- LightGBM Ranker
- ネガティブサンプリング
    - そのままだと正例：負例 = 1:50程度なので、負例をランダムに削除して正例：負例 = 1:2程度に

# アンサンブル
- 上記の候補生成、特徴量エンジニアリング、ネガティブサンプリングの率を変えた3つのモデルをアンサンブル
- アンサンブルの方法はzakopuroさんがあげてくださった[これ](https://www.guruguru.science/competitions/22/discussions/67cc18dd-a0cb-497c-8fca-db98ac023636/)
- ベストシングルモデルと比較してPrivateで+0.0001程度なので、アンサンブルによる寄与はあまりなかった